services:
  postgres:
    image: postgres:17-alpine
    container_name: iac-registry-postgres
    ports:
      - "${POSTGRES_PORT_EXTERNAL:-5432}:5432"
    environment:
      - POSTGRES_DB=registry
      - POSTGRES_USER=registry
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-registry-password-change-me}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - registry-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U registry"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: iac-registry-backend
    ports:
      - "${BACKEND_PORT:-9080}:9080"
    volumes:
      - registry-data:/app/data
      - deployment-workdir:/tmp/iac-deployments
    environment:
      - GIN_MODE=release
      - PORT=${BACKEND_PORT:-9080}
      - BACKEND_HOST=${REGISTRY_HOST:-registry.local}
      - FRONTEND_HOST=${REGISTRY_HOST:-registry.local}
      - FRONTEND_PORT=${FRONTEND_PORT:-3000}
      - VITE_DEV_PORT=5173
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=registry
      - POSTGRES_USER=registry
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-registry-password-change-me}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-change-this-to-a-secure-32-char-key!}
      - RUNNER_URL=http://runner:8080
      - REGISTRY_HOST=${REGISTRY_HOST:-registry.local}
    restart: unless-stopped
    networks:
      - registry-network
    depends_on:
      postgres:
        condition: service_healthy
      runner:
        condition: service_started

  runner:
    build:
      context: ./runner
      dockerfile: Dockerfile
    container_name: iac-runner
    ports:
      - "${RUNNER_PORT:-8080}:8080"
    volumes:
      - deployment-workdir:/tmp/iac-deployments
    environment:
      - ALLOWED_ORIGINS=*
      - REGISTRY_HOST=http://${REGISTRY_HOST:-registry.local}:${BACKEND_PORT:-9080}
    extra_hosts:
      - "${REGISTRY_HOST:-registry.local}:host-gateway"
    restart: unless-stopped
    networks:
      - registry-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_REGISTRY_HOST=${REGISTRY_HOST:-registry.local}
        - VITE_REGISTRY_PORT=${BACKEND_PORT:-9080}
        - VITE_API_BASE_URL=http://localhost:${BACKEND_PORT:-9080}/api
    container_name: iac-registry-frontend
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    environment:
      - PORT=3000
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - registry-network

volumes:
  postgres-data:
  registry-data:
  deployment-workdir:

networks:
  registry-network:
    driver: bridge
